import{g as Y,d as Z,b as ee,a as H,k as te,r as n,j as e,L as E,f as I}from"./index-BxsvggaG.js";import{a as O}from"./Skeleton-BiEkAveh.js";import{R as se}from"./ReportModal-DbEHjK7l.js";function re({message:t,isOwn:i,currentUserId:p,otherUserId:_,onOrderAction:r}){var v,k,o;const[g,y]=n.useState(!1),[j,N]=n.useState(!1),{addToast:b}=H(),w=async()=>{var d,c;if(t.order_id){N(!0);try{await I.post(`/api/v1/orders/${t.order_id}/approve`),b({type:"success",message:"Order approved!"}),r&&r()}catch(u){b({type:"error",message:((c=(d=u.response)==null?void 0:d.data)==null?void 0:c.message)||"Failed to approve"})}finally{N(!1)}}},L=async()=>{var c,u;const d=prompt("Reason for rejection (optional):");if(d!==null&&t.order_id){N(!0);try{await I.post(`/api/v1/orders/${t.order_id}/reject`,{reason:d||"Payment not confirmed"}),b({type:"info",message:"Order rejected"}),r&&r()}catch(M){b({type:"error",message:((u=(c=M.response)==null?void 0:c.data)==null?void 0:u.message)||"Failed to reject"})}finally{N(!1)}}},h=t.message_type==="receipt",R=h&&((v=t.content)==null?void 0:v.includes("Awaiting your approval")),m=h&&((k=t.content)==null?void 0:k.includes("APPROVED")),l=h&&((o=t.content)==null?void 0:o.includes("REJECTED")),C=R&&!i&&t.order_id&&!m&&!l;return e.jsx("div",{className:`flex ${i?"justify-end":"justify-start"} mb-3`,children:e.jsxs("div",{className:`max-w-[85%] ${i?"order-2":""}`,children:[(t.message_type==="image"||t.message_type==="media")&&t.media_url&&e.jsxs("div",{className:"relative rounded-2xl overflow-hidden mb-1",children:[!g&&e.jsx("div",{className:"w-48 h-48 bg-gray-200 animate-pulse"}),e.jsx("img",{src:t.media_url,alt:"",className:`max-w-full h-auto ${g?"":"hidden"}`,onLoad:()=>y(!0),onClick:()=>window.open(t.media_url,"_blank")})]}),h&&e.jsxs("div",{className:`rounded-2xl overflow-hidden shadow-sm border-2 ${m?"border-green-200 bg-green-50":l?"border-red-200 bg-red-50":"border-blue-200 bg-blue-50"}`,children:[e.jsx("div",{className:`px-3 py-2 font-medium text-sm ${m?"bg-green-100 text-green-800":l?"bg-red-100 text-red-800":"bg-blue-100 text-blue-800"}`,children:m?"âœ… Payment Approved":l?"âŒ Payment Rejected":"ðŸ“§ Payment Receipt"}),e.jsxs("div",{className:"p-3",children:[e.jsx("p",{className:`text-sm whitespace-pre-wrap ${m?"text-green-700":l?"text-red-700":"text-blue-700"}`,children:t.content}),C&&e.jsxs("div",{className:"mt-3 pt-3 border-t border-blue-200 flex gap-2",children:[e.jsx("button",{onClick:L,disabled:j,className:"flex-1 py-2 px-3 bg-white border border-red-300 text-red-600 rounded-lg text-sm font-medium hover:bg-red-50 disabled:opacity-50",children:"Reject"}),e.jsx("button",{onClick:w,disabled:j,className:"flex-1 py-2 px-3 bg-green-500 text-white rounded-lg text-sm font-medium hover:bg-green-600 disabled:opacity-50",children:j?"Processing...":"Approve âœ“"})]}),t.order_id&&e.jsx(E,{to:`/order/${t.order_id}`,className:"mt-2 block text-center text-xs text-gray-500 hover:text-primary-600",children:"View Order Details â†’"})]})]}),t.message_type==="order"&&e.jsxs("div",{className:`p-3 rounded-2xl ${i?"bg-primary-500":"bg-gray-100"}`,children:[e.jsxs("div",{className:"flex items-center gap-2 mb-1",children:[e.jsx("span",{children:"ðŸ“¦"}),e.jsx("span",{className:`text-sm font-medium ${i?"text-white":"text-gray-900"}`,children:"Order Message"})]}),e.jsx("p",{className:`text-sm ${i?"text-white/90":"text-gray-600"}`,children:t.content})]}),(t.message_type==="text"||!t.message_type)&&t.content&&e.jsx("div",{className:`px-4 py-2 rounded-2xl ${i?"bg-primary-500 text-white rounded-br-md":"bg-gray-100 text-gray-900 rounded-bl-md"}`,children:e.jsx("p",{className:"text-sm whitespace-pre-wrap",children:t.content})}),e.jsxs("p",{className:`text-xs mt-1 ${i?"text-right":""} text-gray-400`,children:[ae(t.created_at),i&&t.is_read&&e.jsx("span",{className:"ml-1",children:"âœ“âœ“"})]})]})})}function ae(t){return new Date(t).toLocaleTimeString("en",{hour:"2-digit",minute:"2-digit"})}function oe(){var B,W,D,z,V;const{chatId:t}=Y(),i=Z(),{user:p}=ee(),{addToast:_}=H(),{currentChat:r,messages:g,fetchMessages:y,sendMessage:j,setTyping:N,typingUsers:b,isLoadingMessages:w,error:L,connectSocket:h,clearCurrentChat:R,socket:m}=te(),[l,C]=n.useState(""),[v,k]=n.useState(!1),[o,d]=n.useState(null),[c,u]=n.useState(null),[M,$]=n.useState(!1),[P,T]=n.useState(null),[J,A]=n.useState(!1),F=n.useRef(null),U=n.useRef(null),S=n.useRef(null);n.useEffect(()=>{m||h()},[m,h]),n.useEffect(()=>(t&&(T(null),y(t).catch(s=>{console.error("Failed to fetch messages:",s),T("Failed to load chat. Please try again.")})),()=>{R()}),[t,y,R]),n.useEffect(()=>{var s;(s=F.current)==null||s.scrollIntoView({behavior:"smooth"})},[g]);const q=async s=>{var x;if(s.preventDefault(),!(!l.trim()&&!o||v)){k(!0);try{if(o){$(!0);const f=new FormData;f.append("file",o),f.append("chat_id",t);const X=await I.post("/api/v1/uploads/chat",f,{headers:{"Content-Type":"multipart/form-data"}});await j(t,l.trim()||"","media",X.data.url),$(!1)}else await j(t,l.trim());C(""),d(null),u(null),(x=U.current)==null||x.focus()}catch{_({type:"error",message:"Failed to send message"}),$(!1)}finally{k(!1)}}},G=s=>{C(s.target.value)},K=s=>{var f;const x=(f=s.target.files)==null?void 0:f[0];if(x){if(x.size>5*1024*1024){_({type:"error",message:"File size must be less than 5MB"});return}if(!x.type.startsWith("image/")&&!x.type.startsWith("video/")){_({type:"error",message:"Only images and videos are allowed"});return}d(x),u(URL.createObjectURL(x))}},Q=()=>{d(null),u(null),S.current&&(S.current.value="")},a=r==null?void 0:r.other_user;return P||L&&!w?e.jsx("div",{className:"min-h-screen bg-gray-50 flex items-center justify-center p-4",children:e.jsxs("div",{className:"text-center max-w-sm",children:[e.jsx("span",{className:"text-6xl block mb-4",children:"ðŸ˜•"}),e.jsx("h2",{className:"text-xl font-bold text-gray-900 mb-2",children:"Chat Not Found"}),e.jsx("p",{className:"text-gray-500 mb-6",children:P||L||"This chat could not be loaded. It may have been deleted or you may not have access to it."}),e.jsxs("div",{className:"flex gap-3 justify-center",children:[e.jsx("button",{onClick:()=>i("/chat"),className:"btn-secondary px-6",children:"Back to Chats"}),e.jsx("button",{onClick:()=>{T(null),y(t)},className:"btn-primary px-6",children:"Try Again"})]})]})}):w&&!r?e.jsx("div",{className:"min-h-screen bg-gray-50 flex items-center justify-center",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"w-12 h-12 border-4 border-primary-500 border-t-transparent rounded-full animate-spin mx-auto mb-4"}),e.jsx("p",{className:"text-gray-600",children:"Loading chat..."})]})}):e.jsxs("div",{className:"min-h-screen bg-gray-50 flex flex-col",children:[e.jsxs("div",{className:"sticky top-0 bg-white border-b border-gray-100 px-4 py-3 flex items-center gap-3 z-10",children:[e.jsx(E,{to:"/chat",className:"p-2 -ml-2 text-gray-600",children:e.jsx("svg",{className:"w-6 h-6",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M15 19l-7-7 7-7"})})}),a?e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"flex items-center gap-3 flex-1 cursor-pointer",onClick:()=>{a.store_id&&i(`/store/${a.store_id}`)},children:[e.jsx("div",{className:"w-10 h-10 rounded-full bg-gradient-to-br from-primary-400 to-accent-500 flex items-center justify-center text-white font-medium",children:a.avatar_url?e.jsx("img",{src:a.avatar_url,alt:"",className:"w-full h-full rounded-full object-cover"}):(B=a.first_name)==null?void 0:B[0]}),e.jsxs("div",{className:"flex-1",children:[e.jsxs("h3",{className:"font-medium text-gray-900",children:[a.first_name," ",a.last_name]}),(W=b[t])!=null&&W.includes(a.id)?e.jsx("p",{className:"text-xs text-primary-500",children:"typing..."}):a.store_name?e.jsxs("p",{className:"text-xs text-primary-500 hover:underline",children:[a.store_name," â†’"]}):e.jsx("p",{className:"text-xs text-gray-500",children:"Online"})]})]}),e.jsx("button",{onClick:()=>A(!0),className:"p-2 text-gray-400 hover:text-red-500 transition-colors",title:"Report User",children:e.jsx("svg",{className:"w-5 h-5",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"})})})]}):e.jsx(O,{className:"h-10 w-40"})]}),e.jsx(se,{isOpen:J,onClose:()=>A(!1),entityType:"user",entityId:a==null?void 0:a.id}),(r==null?void 0:r.product)&&e.jsxs(E,{to:`/product/${r.product.id}`,className:"bg-white border-b border-gray-100 px-4 py-2 flex items-center gap-3",children:[e.jsx("div",{className:"w-10 h-10 rounded-lg bg-gray-100 overflow-hidden",children:(z=(D=r.product.media)==null?void 0:D[0])!=null&&z.url?e.jsx("img",{src:r.product.media[0].url,alt:"",className:"w-full h-full object-cover"}):e.jsx("span",{className:"text-xl flex items-center justify-center h-full",children:"ðŸ“¦"})}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("p",{className:"text-sm font-medium text-gray-900 truncate",children:r.product.title}),e.jsxs("p",{className:"text-xs text-primary-600",children:["â‚¦",(V=r.product.price)==null?void 0:V.toLocaleString()]})]}),e.jsx("svg",{className:"w-4 h-4 text-gray-400",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M9 5l7 7-7 7"})})]}),e.jsxs("div",{className:"flex-1 overflow-y-auto p-4",children:[w?e.jsx("div",{className:"space-y-3",children:[1,2,3].map(s=>e.jsx("div",{className:`flex ${s%2===0?"justify-end":"justify-start"}`,children:e.jsx(O,{className:`h-10 ${s%2===0?"w-48":"w-56"} rounded-2xl`})},s))}):g.length>0?g.map(s=>e.jsx(re,{message:s,isOwn:s.sender_id===(p==null?void 0:p.id),currentUserId:p==null?void 0:p.id,otherUserId:a==null?void 0:a.id,onOrderAction:()=>y(t)},s.id)):e.jsx("div",{className:"text-center py-8 text-gray-500",children:e.jsx("p",{children:"No messages yet. Say hello! ðŸ‘‹"})}),e.jsx("div",{ref:F})]}),c&&e.jsxs("div",{className:"bg-white border-t border-gray-100 px-4 py-3",children:[e.jsxs("div",{className:"relative inline-block",children:[o!=null&&o.type.startsWith("video/")?e.jsx("video",{src:c,className:"max-h-32 rounded-lg"}):e.jsx("img",{src:c,alt:"Preview",className:"max-h-32 rounded-lg"}),e.jsx("button",{onClick:Q,className:"absolute -top-2 -right-2 w-6 h-6 bg-red-500 text-white rounded-full flex items-center justify-center text-sm",children:"Ã—"})]}),M&&e.jsx("p",{className:"text-xs text-gray-500 mt-1",children:"Uploading..."})]}),e.jsxs("form",{onSubmit:q,className:"sticky bottom-0 bg-white border-t border-gray-100 px-4 py-3 flex items-center gap-3",children:[e.jsx("input",{ref:S,type:"file",accept:"image/*,video/*",onChange:K,className:"hidden"}),e.jsx("button",{type:"button",onClick:()=>{var s;return(s=S.current)==null?void 0:s.click()},className:"p-2 text-gray-400 hover:text-gray-600",children:e.jsx("svg",{className:"w-6 h-6",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"})})}),e.jsx("input",{ref:U,type:"text",value:l,onChange:G,placeholder:"Type a message...",className:"flex-1 bg-gray-100 rounded-full px-4 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-primary-500"}),e.jsx("button",{type:"submit",disabled:!l.trim()&&!o||v,className:`p-2 rounded-full ${(l.trim()||o)&&!v?"bg-primary-500 text-white":"bg-gray-100 text-gray-400"}`,children:e.jsx("svg",{className:"w-5 h-5",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M12 19l9 2-9-18-9 18 9-2zm0 0v-8"})})})]})]})}export{oe as default};
